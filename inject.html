<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Socket.io</title>
    </head>
 
    <body>
        <h1>Communication avec socket.io !</h1>

        <p><input type="button" value="EmbÃªter le serveur" id="poke" /></p>


        <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
        <!-- <script src="/socket.io/socket.io.js"></script> --> <!-- when served from nodejs server -->
        <script src="http://localhost:8080/socket.io/socket.io.js"></script> <!-- when injected into a page not served by nodejs server -->
        <script>
            // store mouse x,y position
            // updated by moving the cursor using a laptop's trackpad
            // or by receiving wsmouse inputs
            var mousePosition = { x: 0, y: 0 };
            // allow updating mouse position using laptop trackpad ( !== wsmouse inputs )
            document.addEventListener('mousemove', function(e){
              mousePosition = { x: e.clientX, y: e.clientY};
            });
            
            // mouse buttons map - to convert from L: 1, R: 2, M: 4 to L: 0, R: 2, M: 1
            var wsMouseBtnsMap = function(btn){
              if(btn === 0) return -1; // None
              else if(btn === 1) return 0; // Left btn
              else if (btn === 4) return 1; // // Middle btn
              else return btn; // Right btn
            }
            
            // reverse key map ( so as to keep the original key values untouched for debugging puroses )
            var revKeyMap = {
              '4': 97,    // A
              '5': 98,    // B
              '6': 99,    // C
              '7': 100,   // D
              '8': 101,   // E
              '9': 102,   // F
              '10': 103,  // G
              '11': 104,  // H
              '12': 105,  // I
              '13': 106,  // J
              '14': 107,  // K
              '15': 108,  // L
              '16': 109,  // M
              '17': 110,  // N
              '18': 111,  // O
              '19': 112,  // P
              '20': 113,  // Q
              '21': 114,  // R
              '22': 115,  // S
              '23': 116,  // T
              '24': 117,  // U
              '25': 118,  // V
              '26': 119,  // W
              '27': 120,  // X
              '28': 121,  // Y
              '29': 122,  // Z
              '30': 49,   // 1
              '31': 50,   // 2
              '32': 51,   // 3
              '33': 52,   // 4
              '34': 53,   // 5
              '35': 54,   // 6
              '36': 55,   // 7
              '37': 56,   // 8
              '38': 57,   // 9
              '39': 48,   // 0
              '40': 13,   //  ENTER
              //'40': ,   // "\n"
              //'41': ,   // ESC
              //'42': ,   // BACKSPACE        
              //'43': ,   // "\t"
              '44': 32,   // " "
              '45': 45,   // "-"
              '46': 61,   // "="
              '47': 91,   // "["
              '48': 93,   // "]"
              '49': 92,   // "\\"
              //'50': ,   // NUMBER
              '51': 59,   // ";"
              '52': 39,   // "'"
              '53': 126,   // "~"
              '54': 44,   // ","
              '55': 46,   // "."
              '56': 47,   // "/"
              //'57': ,   // CAPS_LOCK
              //'58': ,   // F1
              //'59': ,   // F2
              //'60': ,   // F3
              //'61': ,   // F4
              //'62': ,   // F5
              //'63': ,   // F6
              //'64': ,   // F7
              //'65': ,   // F8
              //'66': ,   // F9
              //'67': ,   // F10
              //'68': ,   // F11
              //'69': ,   // F12
              //'70': ,   // PRINTSCREEN
              //'71': ,   // SCROLL_LOCK
              //'72': ,   // PAUSE
              //'73': ,   // INSERT
              //'74': ,   // HOME
              //'75': ,   // PAGE_UP
              '76': 127,  // DELETE
              //'77': ,   // END
              //'78': ,   // PAGE_DOWN
              '79': 39,   // RIGHT - keydown only
              '80': 37,   // LEFT - keydown only
              '81': 40,   // DOWN - keydown only
              '82': 38,   // UP - keydown only
              //'83': ,   // NUM_LOCK
              //'84': ,   // PAD_SLASH
              //'85': ,   // PAD_ASTERIX
              //'86': ,   // PAD_MINUS
              //'87': ,   // PAD_PLUS
              //'88': ,   // PAD_ENTER
              //'89': ,   // PAD_1
              //'90': ,   // PAD_2
              //'91': ,   // PAD_3
              //'92': ,   // PAD_4
              //'93': ,   // PAD_5
              //'94': ,   // PAD_6
              //'95': ,   // PAD_7
              //'96': ,   // PAD_8
              //'97': ,   // PAD_9
              //'98': ,   // PAD_0
              //'99':     // PAD_PERIOD
            };
            
            var socket = io.connect('http://localhost:8080');

            // data = 'test';
            //socket.emit('stuff', data);

            // received mouse/keyboard inputs coming from websockets & originating from serial
            socket.on('message', function(message) {
                console.log('server message : ' + message);
                // parse the coming data
                var dataObj = JSON.parse(data);
                if(Object.keys(dataObj)[0] === 'wsmouse.send'){ // wsmouse: { 'wsmouse.send': ([btn,x,y,s] }
                  // TODO: get current mouse position
                  var currMousePos = mousePosition;
                  
                  // TODO: parse the wsmouse.send evt data
                  var wsMouseEvtData = dataObj[ Object.keys(dataObj)[0] ];
                  var wsMouseData = { x: wsMouseEvtData[0], y: wsMouseEvtData[1], btn: wsMouseEvtData[2], wheel: wsMouseEvtData[3] };
                  console.log('wsMouseData: ' + wsMouseData);
                  var wsMouseBtn = wsMouseBtnsMap( wsMouseData.btn ); // /!\ -1 means None
                  
                  // TODO: simulate a mouse evt ( move, button click, .. )
                  var mouseEvent = document.createEvent("MouseEvents");
                  mouseEvent.initMouseEvent(
                    "mousemove", //event type : mousedown, mouseup, mousemove, [ click, mouseover, mouseout ].  
                    true, //canBubble
                    false, //cancelable
                    window, //event's AbstractView : should be window 
                    0, // detail : Event's mouse click count 
                    mousePosition.x + wsMouseData.x, // screenX
                    mousePosition.y + wsMouseData.y, // screenY
                    mousePosition.x + wsMouseData.x, // clientX
                    mousePosition.y + wsMouseData.y, // clientY
                    false, // ctrlKey
                    false, // altKey
                    false, // shiftKey
                    false, // metaKey 
                    0, // button : 0 = left button, 1 = middle button, 2 = right button  
                    null // relatedTarget : Only used with some event types (e.g. mouseover and mouseout). In other cases, pass null.
                  );
                  document.dispatchEvent(mouseEvent);
                  //document.querySelector('canvas').dispatchEvent(mouseEvent); // always good to remember ;)
                    
                } else if (Object.keys(dataObj)[0] === 'wskeyboard.tap'){ // wskeyboard: { 'wskeyboard.tap': ([modifiers,key] }
                  // TODO: parse the wskeyboard.tap evt data
                  var wsKeyboardEvtData = dataObj[ Object.keys(dataObj)[0] ];
                  var wsKeyboardData = { modifiers: wsKeyboardEvtData[0], key: wsKeyboardEvtData[1] };
                  console.log('wsKeyboardData: ' + wsKeyboardData);
                  //var wsKeyboardKey = wsKeyboardKeysMap( wsKeyboardData.key ); // /!\ either re-write export.KEYS or write another 'mapping' fcn
                  // if key === 0, we have a keyup event, else we map the key
                  var keyEvtType = undefined;
                  var revMapKey = undefined;
                  if( wsKeyboardData.key.toString() in revKeyMap ){
                    console.log('mapped keyCode: ' + revKeyMap[ wsKeyboardData.key.toString() ] );
                    keyEvtType = 'keydown';
                    revMapKey = revKeyMap[ wsKeyboardData.key.toString() ];
                  } else {
                    console.log('key === 0');
                    keyEvtType = 'keyup';
                  }
                    
                  // TODO: simulate a key evt ( keydown, keypress, keyup )
                  var keyboardEvent = document.createEvent('KeyboardEvent');
                  keyboardEvent.initKeyEvent(
                    keyEvtType, // typeArg ( keydown, keyup, keypress )                                                        
                    true, // canBubbleArg
                    true, // cancelableArg
                    null, // viewArg,  Specifies UIEvent.view. This value may be null.     
                    !!((wsKeyboardData.modifiers>>0) & 1), // ctrlKeyArg ( true || false )
                    !!((wsKeyboardData.modifiers>>2) & 1), // altKeyArg  ( true || false )
                    !!((wsKeyboardData.modifiers>>1) & 1), // shiftKeyArg  ( true || false )
                    !!((wsKeyboardData.modifiers>>3) & 1), // metaKeyArg  ( true || false )
                    revMapKey, // keyCodeArg ( num representing the key on keyboard )
                    0 // charCodeArg ( num representing the unicode char of key on keyboard )
                  );
                  document.dispatchEvent(keyboardEvent);
                
                }
            });
            
            
        </script>
    </body>
</html>
