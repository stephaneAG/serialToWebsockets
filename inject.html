<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Socket.io</title>
    </head>
 
    <body>
        <h1>Communication avec socket.io !</h1>

        <p><input type="button" value="EmbÃªter le serveur" id="poke" /></p>


        <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
        <!-- <script src="/socket.io/socket.io.js"></script> --> <!-- when served from nodejs server -->
        <script src="http://localhost:8080/socket.io/socket.io.js"></script> <!-- when injected into a page not served by nodejs server -->
        <script>
            // store mouse x,y position
            // updated by moving the cursor using a laptop's trackpad
            // or by receiving wsmouse inputs
            var mousePosition = { x: 0, y: 0 };
            // allow updating mouse position using laptop trackpad ( !== wsmouse inputs )
            document.addEventListener('mousemove', function(e){
              mousePosition = { x: e.clientX, y: e.clientY};
            });
            
            // mouse buttons map - to convert from L: 1, R: 2, M: 4 to L: 0, R: 2, M: 1
            var wsMouseBtnsMap = function(btn){
              if(btn === 0) return -1; // None
              else if(btn === 1) return 0; // Left btn
              else if (btn === 4) return 1; // // Middle btn
              else return btn; // Right btn
            }
            
            var socket = io.connect('http://localhost:8080');

            // data = 'test';
            //socket.emit('stuff', data);

            // received mouse/keyboard inputs coming from websockets & originating from serial
            socket.on('message', function(message) {
                console.log('server message : ' + message);
                // parse the coming data
                var dataObj = JSON.parse(data);
                if(Object.keys(dataObj)[0] === 'wsmouse.send'){ // wsmouse: { 'wsmouse.send': ([btn,x,y,s] }
                  // TODO: get current mouse position
                  var currMousePos = mousePosition;
                  
                  // TODO: parse the wsmouse.send evt data
                  var wsMouseEvtData = dataObj[ Object.keys(dataObj)[0] ];
                  var wsMouseData = { x: wsMouseEvtData[0], y: wsMouseEvtData[1], btn: wsMouseEvtData[2], wheel: wsMouseEvtData[3] };
                  console.log('wsMouseData: ' + wsMouseData);
                  var wsMouseBtn = wsMouseBtnsMap( wsMouseData.btn ); // /!\ -1 means None
                  
                  // TODO: simulate a mouse evt ( move, button click, .. )
                  var mouseEvent = document.createEvent("MouseEvents");
                  mouseEvent.initMouseEvent(
                    "mousemove", //event type : mousedown, mouseup, mousemove, [ click, mouseover, mouseout ].  
                    true, //canBubble
                    false, //cancelable
                    window, //event's AbstractView : should be window 
                    0, // detail : Event's mouse click count 
                    mousePosition.x + wsMouseData.x, // screenX
                    mousePosition.y + wsMouseData.y, // screenY
                    mousePosition.x + wsMouseData.x, // clientX
                    mousePosition.y + wsMouseData.y, // clientY
                    false, // ctrlKey
                    false, // altKey
                    false, // shiftKey
                    false, // metaKey 
                    0, // button : 0 = left button, 1 = middle button, 2 = right button  
                    null // relatedTarget : Only used with some event types (e.g. mouseover and mouseout). In other cases, pass null.
                  );
                  document.dispatchEvent(mouseEvent);
                  //document.querySelector('canvas').dispatchEvent(mouseEvent); // always good to remember ;)
                    
                } else if (Object.keys(dataObj)[0] === 'wskeyboard.tap'){ // wskeyboard: { 'wskeyboard.tap': ([modifiers,key] }
                  // TODO: parse the wskeyboard.tap evt data
                  var wsKeyboardEvtData = dataObj[ Object.keys(dataObj)[0] ];
                  var wsKeyboardData = { modifiers: wsKeyboardEvtData[0], key: wsKeyboardEvtData[1] };
                  console.log('wsKeyboardData: ' + wsKeyboardData);
                  var wsKeyboardKey = wsKeyboardKeysMap( wsKeyboardData.key ); // /!\ either re-write export.KEYS or write another 'mapping' fcn
                  // TODO: parse the bitwise-mapped modifiers
                    
                  // TODO: simulate a key evt ( press, release, )
                  var keyboardEvent = document.createEvent('KeyboardEvent');
                  keyboardEvent.initKeyEvent(
                    "keypress", // typeArg,                                                           
                    true, // canBubbleArg,                                                        
                    true, // cancelableArg,                                                       
                    null, // viewArg,  Specifies UIEvent.view. This value may be null.     
                    false, // ctrlKeyArg,                                                               
                    false, // altKeyArg,                                                        
                    false, // shiftKeyArg,                                                      
                    false, // metaKeyArg,                                                       
                    9, // keyCodeArg,                                                      
                    0 // charCodeArg
                  );
                  document.dispatchEvent(keyboardEvent);
                
                }
            });
            
            
        </script>
    </body>
</html>
